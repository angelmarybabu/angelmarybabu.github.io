<!DOCTYPE html><html lang="en" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="layout-lang" content="en"><meta name="day-prompt" content="d ago"><meta name="hour-prompt" content="hr ago"><meta name="minute-prompt" content="min ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Github Actions Self Runner in EKS" /><meta name="author" content="Angel Mary Babu" /><meta property="og:locale" content="en" /><meta name="description" content="Github Actions Self Runner in EKS" /><meta property="og:description" content="Github Actions Self Runner in EKS" /><link rel="canonical" href="https://angelmarybabu.github.io/posts/Self-Runner-in-EKS/" /><meta property="og:url" content="https://angelmarybabu.github.io/posts/Self-Runner-in-EKS/" /><meta property="og:site_name" content="Angel Mary Babu" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-11T08:30:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Github Actions Self Runner in EKS" /><meta name="twitter:site" content="@AngelMaryBabu1" /><meta name="twitter:creator" content="@Angel Mary Babu" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Angel Mary Babu"},"dateModified":"2021-08-23T12:57:53+05:30","datePublished":"2020-10-11T08:30:00+05:30","description":"Github Actions Self Runner in EKS","headline":"Github Actions Self Runner in EKS","mainEntityOfPage":{"@type":"WebPage","@id":"https://angelmarybabu.github.io/posts/Self-Runner-in-EKS/"},"url":"https://angelmarybabu.github.io/posts/Self-Runner-in-EKS/"}</script><title>Github Actions Self Runner in EKS | Angel Mary Babu</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Angel Mary Babu"><meta name="application-name" content="Angel Mary Babu"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://raw.githubusercontent.com/angelmarybabu/angelmarybabu.github.io/master/assets/img/favicons/angel.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Angel Mary Babu</a></div><div class="site-subtitle font-italic">Cloud, DevOps, Site Reliability Engineer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/angelmarybabu" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/AngelMaryBabu1" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['angelmarybabu2','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Github Actions Self Runner in EKS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Github Actions Self Runner in EKS</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Angel Mary Babu </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Oct 11, 2020, 8:30 AM +0530" >Oct 11, 2020<i class="unloaded">2020-10-11T08:30:00+05:30</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Aug 23, 2021, 12:57 PM +0530" >Aug 23, 2021<i class="unloaded">2021-08-23T12:57:53+05:30</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1725 words">9 min read</span></div></div><div class="post-content"><p>Let’s create an EKS cluster,</p><h5 id="create-eks-using-aws-cli">Create EKS using AWS CLI</h5><div lang="sh" class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>aws eks create-cluster <span class="se">\</span>
   <span class="nt">--region</span> us-east-1 <span class="se">\</span>
   <span class="nt">--name</span> cluster-new <span class="se">\</span>
   <span class="nt">--kubernetes-version</span> 1.21 <span class="se">\</span>
   <span class="nt">--role-arn</span> arn:aws:iam::ACCOUNT_ID:role/eksrole <span class="se">\</span>
   <span class="nt">--resources-vpc-config</span> <span class="nv">subnetIds</span><span class="o">=</span>subnet-XXXXXXXXXXX,subnet-XXXXXXXXX,subnet-XXXXXXXXX,securityGroupIds<span class="o">=</span>sg-XXXXXXXXX
</pre></table></code></div></div><p>This will take a few minutes to create the eks cluster. You can check the status using the following command,</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>   aws eks --region us-east-1 describe-cluster --name cluster-new --query cluster.status
</pre></table></code></div></div><p>Once the EKS cluster status changes to <code class="language-plaintext highlighter-rouge">ACTIVE</code> we can connect to the EKS cluster using the following,</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>aws eks --region us-east-1 update-kubeconfig --name cluster-new
</pre></table></code></div></div><h5 id="create-worker-nodes">Create Worker nodes</h5><p>We have our cluster is in place, now we have to deploy the Worker nodes. Here I am trying the self managed worker node using the Cloudformation. Just download the YAML file using the curl command at your local end,</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl -o amazon-eks-nodegroup.yaml https://raw.githubusercontent.com/awslabs/amazon-eks-ami/master/amazon-eks-nodegroup.yaml
</pre></table></code></div></div><p>Upload the downloaded YAML file in the CloudFormation. CloudFormation » Create Stack » Upload a template file » Choose this YAML file.</p><p>Always make sure to fill the EKS cluster name in the parameters so that the worker node could join the cluster.</p><p>Once the Worker nodes have been created, we have to make this worker nodes to join the cluster. Please follow the steps given below,</p><h5 id="join-the-cluster">Join the cluster</h5><ul><li>Download the configuration map:<div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl -o aws-auth-cm.yaml https://amazon-eks.s3.us-west-2.amazonaws.com/cloudformation/2020-10-29/aws-auth-cm.yaml
</pre></table></code></div></div><li>Open the file with your text editor. Replace the &lt;ARN of instance role (not instance profile)&gt; (It can be found from the Cloudformation output page)</ul><p>Sample aws-auth-cm.yaml</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>apiVersion: v1
kind: ConfigMap
metadata:
  name: aws-auth
  namespace: kube-system
data:
  mapRoles: |
    - rolearn: &lt;ARN of instance role (not instance profile)&gt;
      username: system:node:
      groups:
        - system:bootstrappers
        - system:nodes
</pre></table></code></div></div><ul><li>Now, apply the configuration.<div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl apply -f aws-auth-cm.yaml
</pre></table></code></div></div><h5 id="self-hoster-runner-on-the-eks">Self hoster runner on the EKS</h5><p>Now let’s create a self hoster runner on the EKS environment</p></ul><h6 id="to-install-helm">To install helm:</h6><p>If the helm is not installed then, install the helm with the below steps:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
$ chmod 700 get_helm.sh
$ ./get_helm.sh
</pre></table></code></div></div><p><a href="https://helm.sh/docs/intro/install/">Reference</a></p><h6 id="installing-cert-manager-on-kubernetes">Installing cert-manager on Kubernetes</h6><p>actions-runner-controller uses cert-manager for certificate management of Admission Webhook. Make sure you have already installed cert-manager before you install. The installation instructions for cert-manager can be found below.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>$ helm repo add jetstack https://charts.jetstack.io
$ helm repo update
$ kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.4.0/cert-manager.crds.yaml
</pre></table></code></div></div><p>Output:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>customresourcedefinition.apiextensions.k8s.io/certificaterequests.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/certificates.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/challenges.acme.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/clusterissuers.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/issuers.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/orders.acme.cert-manager.io created
</pre></table></code></div></div><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>$ helm install \
 cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --version v1.4.0 \
   # --set installCRDs=true
</pre></table></code></div></div><p><a href="https://cert-manager.io/docs/installation/helm/">Reference</a></p><h6 id="deploy-action-runner-controller">Deploy Action Runner Controller</h6><p>Install the custom resource and actions-runner-controller with kubectl. This will create actions-runner-system namespace in your Kubernetes and deploy the required resources.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>kubectl apply -f https://github.com/actions-runner-controller/actions-runner-controller/releases/download/v0.18.2/actions-runner-controller.yaml
namespace/actions-runner-system created
</pre></table></code></div></div><p>Output:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>customresourcedefinition.apiextensions.k8s.io/horizontalrunnerautoscalers.actions.summerwind.dev created
customresourcedefinition.apiextensions.k8s.io/runnerdeployments.actions.summerwind.dev created
customresourcedefinition.apiextensions.k8s.io/runnerreplicasets.actions.summerwind.dev created
customresourcedefinition.apiextensions.k8s.io/runners.actions.summerwind.dev created
role.rbac.authorization.k8s.io/leader-election-role created
clusterrole.rbac.authorization.k8s.io/manager-role created
clusterrole.rbac.authorization.k8s.io/proxy-role created
rolebinding.rbac.authorization.k8s.io/leader-election-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/manager-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/proxy-rolebinding created
service/controller-manager-metrics-service created
service/webhook-service created
deployment.apps/controller-manager created
certificate.cert-manager.io/serving-cert created
issuer.cert-manager.io/selfsigned-issuer created
mutatingwebhookconfiguration.admissionregistration.k8s.io/mutating-webhook-configuration created
validatingwebhookconfiguration.admissionregistration.k8s.io/validating-webhook-configuration created
</pre></table></code></div></div><h6 id="setting-up-authentication-with-github-api">Setting Up Authentication with GitHub API</h6><p>Deploying Using PAT Authentication:</p><p>Create a personal access token,</p><ol><li>Login to GitHub account and navigate to https://github.com/settings/tokens<li>Click on Generate new token button<li>Select repo (Full Control) scope.<li>Click Generate Token</ol><p>Once you have created the appropriate token, deploy it as a secret to your Kubernetes cluster that you are going to deploy the solution on:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>$ kubectl create secret generic controller-manager \
     -n actions-runner-system \
     --from-literal=github_token=${GITHUB_TOKEN}
</pre></table></code></div></div><p>Now, we have to convert the secret to base64 encoded,</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>echo -n '&lt;Personal-Access-Token&gt;' | base64
</pre></table></code></div></div><p>Update in the secret,</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl edit secret controller-manager     -n actions-runner-system 
</pre></table></code></div></div><h6 id="deploy-self-hosted-runner">Deploy Self-Hosted Runner</h6><p>First, create a namespace to host self-hosted runners resources.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl create namespace self-hosted-runners
</pre></table></code></div></div><p>Next, save the following K8s manifest file as self-hosted-runner.yaml, and modify the following:</p><ul><li>Replace <github-repo-name> with your own repository.</github-repo-name><li>Adjust the minReplicas and maxReplicas as required.</ul><p>vim self-hosted-runner.yaml</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerDeployment
metadata:
  name: runner-deployment
spec:
  template:
    spec:
      repository: &lt;github-repo-name&gt;
---
apiVersion: actions.summerwind.dev/v1alpha1
kind: HorizontalRunnerAutoscaler
metadata:
  name: runner-deployment-autoscaler
spec:
  scaleTargetRef:
    name: runner-deployment
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: TotalNumberOfQueuedAndInProgressWorkflowRuns
    repositoryNames:
    - &lt;github-repo-name&gt;
</pre></table></code></div></div><p>And apply the Kubernetes manifest:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl --namespace self-hosted-runners apply -f self-hosted-runner.yaml
</pre></table></code></div></div><p>Verify the runner is deployed and is in the ready state.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ kubectl --namespace self-hosted-runners get runner
</pre></table></code></div></div><p>Now, navigate to your repository Settings &gt; Actions &gt; Runner to view the registered runner.</p><h6 id="create-a-workflow-to-test-your-self-hosted-runner">Create a workflow to test your self-hosted runner</h6><p>Save and commit the following sample GitHub Actions workflow in .github/workflows/actions.yml in your repository where the self-hosted runner is registered.</p><p>actions.yaml</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre>name: Deploy image to AWS ECR

# Trigger deployment during commit
on: 
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  ecr:
    # Name the Job
    name: build and deploy image to AWS ECR
    # Set the type of machine to run on
    runs-on: self-hosted  # The important part of this workflow is runs-on: self-hosted

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: $
          aws-secret-access-key: $
          aws-region: us-east-1
          
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        
      - name: Check out code
        uses: actions/checkout@v2

 
      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: $
          ECR_REPOSITORY: demo1
          IMAGE_TAG: dev-$
        run: |
          docker build -t demo1 .
          docker tag demo1:latest $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

</pre></table></code></div></div><p>To work with Amazon ECR, first, we need to set up an IAM User. An AWS Identity and Access Management (IAM) user is an entity that you create in AWS to represent the person or application that uses it to interact with AWS.</p><p><a href="https://github.com/aws-actions/amazon-ecr-login">Reference</a></p><p>Create an IAM user and Add the following inline policy for the IAM user Example:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowPush",
            "Effect": "Allow",
            "Action": [
                "ecr:GetAuthorizationToken",
                "ecr:GetDownloadUrlForLayer",
                "ecr:BatchGetImage",
                "ecr:BatchCheckLayerAvailability",
                "ecr:PutImage",
                "ecr:InitiateLayerUpload",
                "ecr:UploadLayerPart",
                "ecr:CompleteLayerUpload"
            ],
            "Resource": "*"
        }
    ]
}
</pre></table></code></div></div><p>We need to set up these credentials in our GitHub Action, so we can access them like environment variables. Here we will be providing information related to my AWS access keys along with ECR repository information.</p><p><a href="https://docs.github.com/en/actions/reference/encrypted-secrets">Reference</a></p><p>Now the deployment will trigger whenever any changes are pushed into the repository.</p><p>Hence, let’s create a sample Dockerfile,</p><p>Dockerfile</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>
# ./Dockerfile

FROM node:12-alpine as node-angular-cli

RUN apk update \
  &amp;&amp; apk add --update alpine-sdk \
  &amp;&amp; apk del alpine-sdk \
  &amp;&amp; rm -rf /tmp/* /var/cache/apk/* *.tar.gz ~/.npm \
  &amp;&amp; npm cache verify \
  &amp;&amp; sed -i -e "s/bin\/ash/bin\/sh/" /etc/passwd

# Angular CLI
RUN npm install -g @angular/cli@8
</pre></table></code></div></div><p>Once the changes has been pushed to the repo, the actions will trigger automatically.</p><p>You should find the logs showing that Listening for Jobs.</p><p>Sample output:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
</pre><td class="rouge-code"><pre>[ec2-user@ ~]$ kubectl -n self-hosted-runners  logs -f runner-deployment-jlgtc-fzrdz  -c runner
Github endpoint URL https://github.com/
 
--------------------------------------------------------------------------------
|        ____ _ _   _   _       _          _        _   _                      |
|       / ___(_) |_| | | |_   _| |__      / \   ___| |_(_) ___  _ __  ___      |
|      | |  _| | __| |_| | | | | '_ \    / _ \ / __| __| |/ _ \| '_ \/ __|     |
|      | |_| | | |_|  _  | |_| | |_) |  / ___ \ (__| |_| | (_) | | | \__ \     |
|       \____|_|\__|_| |_|\__,_|_.__/  /_/   \_\___|\__|_|\___/|_| |_|___/     |
|                                                                              |
|                       Self-hosted runner registration                        |
|                                                                              |
--------------------------------------------------------------------------------
 
# Authentication
 
 
√ Connected to GitHub
 
# Runner Registration
 
 
 
A runner exists with the same name
√ Successfully replaced the runner
√ Runner connection is good
 
# Runner settings
 
 
√ Settings Saved.
 
Runner has successfully been configured with the following data.
{
  "agentId": 2,
  "agentName": "runner-deployment-jlgtc-fzrdz",
  "poolId": 1,
  "poolName": "Default",
  "serverUrl": "https://pipelines.actions.githubusercontent.com/rdzYJCV3fzV1bREIFyCultSx1LtQ4F0AKUEat9ZtIqn9ue0Itn",
  "gitHubUrl": "https://github.com/ponnu777/github-actions-runner",
  "workFolder": "/runner/_work"
}16c16
&lt; ./externals/node12/bin/node ./bin/RunnerService.js &amp;
---
&gt; ./externals/node12/bin/node ./bin/RunnerService.js $* &amp;
20c20
&lt; wait $PID
---
&gt; wait $PID
\ No newline at end of file
19c19
&lt; var runService = function () {
---
&gt; var runService = function() {
23c23
&lt;     if (!stopping) {
---
&gt;     if(!stopping) {
27c27
&lt;                 listener = childProcess.spawn(listenerExePath, ['run'], { env: process.env });
---
&gt;                 listener = childProcess.spawn(listenerExePath, ['run'].concat(process.argv.slice(3)), { env: process.env });
30c30
&lt;                 listener = childProcess.spawn(listenerExePath, ['run', '--startuptype', 'service'], { env: process.env });
---
&gt;                 listener = childProcess.spawn(listenerExePath, ['run', '--startuptype', 'service'].concat(process.argv.slice(2)), { env: process.env });
33c33
&lt;             console.log(`Started listener process, pid: ${listener.pid}`);
---
&gt;             console.log('Started listener process');
43,46d42
&lt;             listener.on("error", (err) =&gt; {
&lt;                 console.log(`Runner listener fail to start with error ${err.message}`);
&lt;             });
&lt; 
64c60
&lt;                 if (!stopping) {
---
&gt;                 if(!stopping) {
69c65
&lt;         } catch (ex) {
---
&gt;         } catch(ex) {
78c74
&lt; var gracefulShutdown = function (code) {
---
&gt; var gracefulShutdown = function(code) {
95c91
&lt; });
---
&gt; });
\ No newline at end of file
.path=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/runner/.local/bin
Starting Runner listener with startup type: service
Started listener process
Started running service
 
 
√ Connected to GitHub
 
2021-07-26 11:12:50Z: Listening for Jobs
2021-07-26 11:12:53Z: Running job: build and deploy image to AWS ECR
2021-07-26 11:13:33Z: Job build and deploy image to AWS ECR completed with result: Succeeded
Runner listener exited with error code 0
Runner listener exit with 0 return code, stop the service, no retry needed.

</pre></table></code></div></div><p>That’s it!!!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/aws/'>AWS</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >AWS</a> <a href="/tags/devops/" class="post-tag no-text-decoration" >devops</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Github Actions Self Runner in EKS - Angel Mary Babu&url=https://angelmarybabu.github.io/posts/Self-Runner-in-EKS/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Github Actions Self Runner in EKS - Angel Mary Babu&u=https://angelmarybabu.github.io/posts/Self-Runner-in-EKS/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Github Actions Self Runner in EKS - Angel Mary Babu&url=https://angelmarybabu.github.io/posts/Self-Runner-in-EKS/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/pods-stuck/">Pods stuck in ContainerCreating status - failed to assign an IP address to the container</a><li><a href="/posts/pods-stuck/">Pods stuck in ContainerCreating status - failed to assign an IP address to the container</a><li><a href="/posts/How-to-create-Persistent-Volume-in-EKS/">How to create Persistent Volume in EKS?</a><li><a href="/posts/eks-cluster-rancher/">How to add an EKS cluster in Rancher?</a><li><a href="/posts/argocd/">ArgoCD setup in EKS Cluster</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/amazon/">amazon</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/containerization/">containerization</a> <a class="post-tag" href="/tags/rancher/">rancher</a> <a class="post-tag" href="/tags/sysops/">sysops</a> <a class="post-tag" href="/tags/typography/">typography</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Prometheus-Grafana/"><div class="card-body"> <span class="timeago small" >May 20, 2020<i class="unloaded">2020-05-20T08:30:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to install and configure Prometheus as well as Grafana for an EC2 instance?</h3><div class="text-muted small"><p> Prometheus is one of the widely accepted open source monitoring tools and it takes metrics from the client machine using the node exporter. It displays them using Grafana which gives more visibilit...</p></div></div></a></div><div class="card"> <a href="/posts/velero-backup/"><div class="card-body"> <span class="timeago small" >Dec 6, 2021<i class="unloaded">2021-12-06T08:30:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Velero Backup for EKS</h3><div class="text-muted small"><p> Prerequisites AWS CLI needs to be configured in the machine where you execute Velero commands. Kubectl needs to be configured with the EKS cluster where you need to take the backup. Now we h...</p></div></div></a></div><div class="card"> <a href="/posts/argocd/"><div class="card-body"> <span class="timeago small" >Dec 15, 2021<i class="unloaded">2021-12-15T08:30:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ArgoCD setup in EKS Cluster</h3><div class="text-muted small"><p> ArgoCD is a gitops tool to perform the deployments in kubernetes environment and it consists of three main components. API Server Repository Server Application Controller Prerequisite Y...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Prometheus-Grafana/" class="btn btn-outline-primary" prompt="Older"><p>How to install and configure Prometheus as well as Grafana for an EC2 instance?</p></a> <a href="/posts/docker-commands/" class="btn btn-outline-primary" prompt="Newer"><p>Docker commands</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/AngelMaryBabu1">Angel Mary Babu</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/amazon/">amazon</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/containerization/">containerization</a> <a class="post-tag" href="/tags/rancher/">rancher</a> <a class="post-tag" href="/tags/sysops/">sysops</a> <a class="post-tag" href="/tags/typography/">typography</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://angelmarybabu.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
